{% extends 'base.html' %}

{% block content %}
<style>
    :root {
        --border-color: #e0e0e0;
        --header-bg: #f7f7f7;
        --card-bg: #ffffff;
        --shadow: 0 2px 5px rgba(0,0,0,0.05);
        --primary-text: #333;
        --secondary-text: #555;
        --accent-color: #007bff;
        --positive-color: #28a745;
        --negative-color: #dc3545;
    }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        margin: 2em; 
        background-color: #fcfcfc;
        color: var(--primary-text);
    }
    .detail-header {
        padding: 1.5em;
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1.5em;
        box-shadow: var(--shadow);
    }
    .detail-header h1 { margin: 0 0 0.5em 0; }
    .detail-header a { color: var(--accent-color); text-decoration: none; }
    .detail-header a:hover { text-decoration: underline; }

    .totals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5em;
        padding: 1.5em;
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1.5em;
        box-shadow: var(--shadow);
    }
    .total-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1em;
        text-align: center;
    }
    .total-card h4 {
        margin: 0 0 0.5em 0;
        font-size: 0.9em;
        font-weight: 500;
        color: var(--secondary-text);
    }
    .total-card p {
        margin: 0;
        font-size: 1.8em;
        font-weight: 600;
        color: var(--primary-text);
    }
    .metric-change {
        font-size: 0.8em;
        margin-top: 0.5em;
        font-weight: 500;
    }
    .positive { color: var(--positive-color); }
    .negative { color: var(--negative-color); }

    details {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1em;
        box-shadow: var(--shadow);
    }
    summary {
        font-weight: bold;
        padding: 1em 1.5em;
        cursor: pointer;
        outline: none;
    }
    summary::-webkit-details-marker { display: none; }
    summary::before {
        content: 'â–¶';
        margin-right: 0.75em;
        display: inline-block;
        transition: transform 0.2s;
        font-size: 0.8em;
    }
    details[open] > summary { border-bottom: 1px solid var(--border-color); }
    details[open] > summary::before { transform: rotate(90deg); }
    
    .monthly-content {
        padding: 0 1.5em 1.5em 1.5em;
    }
    .business-view-list {
        list-style-type: none;
        padding: 0;
    }
    .business-view-item {
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1em;
        margin-top: 1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .business-view-item strong {
        color: var(--primary-text);
    }
    .business-view-metrics {
        display: flex;
        gap: 1.5em;
        font-size: 0.9em;
        color: var(--secondary-text);
    }
</style>

<div class="detail-header">
    <!-- MODIFIED: Updated link to point to the main upload page. -->
    <a href="{{ url_for('index') }}">&larr; Back to Upload Page</a>
    <h1>{% block title %}{{ hotel.name }}{% endblock %}</h1>
</div>

<!-- MODIFIED: This grid now shows the metrics calculated in app.py -->
<div class="totals-grid">
    <div class="total-card">
        <h4>Total Forecast Revenue</h4>
        <p>${{ "{:,.0f}".format(hotel.metrics.forecast_rev) }}</p>
    </div>
    <div class="total-card">
        <h4>Overall Occupancy</h4>
        <p>{{ "{:.1f}%".format(hotel.metrics.occ_percent) }}</p>
    </div>
    <div class="total-card">
        <h4>Occupancy vs. Last Year</h4>
        <p class="metric-change {{ 'positive' if hotel.metrics.occ_vs_ly > 0 else 'negative' }}">
            {{ "{:+.1f}%".format(hotel.metrics.occ_vs_ly) }}
        </p>
    </div>
</div>

<!-- MODIFIED: This section now iterates through the correct data structure and displays metrics for each month and business view. -->
{% for month in hotel.children %}
<details>
    <summary><h3>{{ month.name }}</h3></summary>
    
    <div class="monthly-content">
        <div class="totals-grid">
            <div class="total-card">
                <h4>Month Forecast Revenue</h4>
                <p>${{ "{:,.0f}".format(month.metrics.forecast_rev) }}</p>
            </div>
            <div class="total-card">
                <h4>Month Occupancy</h4>
                <p>{{ "{:.1f}%".format(month.metrics.occ_percent) }}</p>
            </div>
            <div class="total-card">
                <h4>Month Occupancy vs. LY</h4>
                <p class="metric-change {{ 'positive' if month.metrics.occ_vs_ly > 0 else 'negative' }}">
                    {{ "{:+.1f}%".format(month.metrics.occ_vs_ly) }}
                </p>
            </div>
        </div>

        <h4>Breakdown by Business View</h4>
        <ul class="business-view-list">
            {% for view in month.children %}
            <li class="business-view-item">
                <strong>{{ view.name }}</strong>
                <div class="business-view-metrics">
                    <span><strong>Revenue:</strong> ${{ "{:,.0f}".format(view.metrics.forecast_rev) }}</span>
                    <span><strong>Occupancy:</strong> {{ "{:.1f}%".format(view.metrics.occ_percent) }}</span>
                </div>
            </li>
            {% else %}
            <li>No business view data for this month.</li>
            {% endfor %}
        </ul>
    </div>
</details>
{% endfor %}

{% endblock %}
