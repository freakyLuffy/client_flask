{% extends 'base.html' %}

{% block content %}
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f5f7; }
    .dashboard-container { max-width: 1200px; margin: 2em auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
    .dashboard-header { padding: 1.5em; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .action-links a { color: #007bff; text-decoration: none; margin-left: 1em; }
    .dashboard-table { width: 100%; border-collapse: collapse; }
    .dashboard-table th, .dashboard-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9e9e9; }
    .dashboard-table th { background-color: #f9fafb; font-weight: 600; color: #555; }
    .dashboard-table td:not(:first-child) { text-align: right; }
    .dashboard-table tr:last-child td { border-bottom: none; }
    .toggle { cursor: pointer; user-select: none; display: inline-block; width: 20px; text-align: center; font-weight: bold; }
    .row-name { display: inline-block; }
    /* Indentation for hierarchy */
    .level-1 { padding-left: 25px; }
    .level-2 { padding-left: 50px; }
    .level-3 { padding-left: 75px; }
    .level-4 { padding-left: 100px; color: #666; font-size: 0.9em; }
    .hidden { display: none; }
    .positive { color: #28a745; }
    .negative { color: #dc3545; }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>{% block title %}Portfolio Dashboard{% endblock %}</h1>
        <div class="action-links">
            <a href="{{ url_for('index') }}">Upload New File</a>
            <a href="{{ url_for('reset_data') }}">Clear Data</a>
        </div>
    </div>
    <table class="dashboard-table">
        <thead>
            <tr>
                <th></th>
                <th>Occupancy on Books</th>
                <th>Occupancy vs. Last Year</th>
                <th>Total Forecasted Room Rev</th>
            </tr>
        </thead>
        <tbody>
            {% macro render_row(item, level) %}
            <tr data-level="{{ level }}" class="parent">
                <td>
                    <span style="padding-left: {{ level * 25 }}px;">
                        {% if item.children %}
                            <span class="toggle" onclick="toggleChildren(this)">[-]</span>
                        {% else %}
                            <span style="display:inline-block; width: 20px;"></span>
                        {% endif %}
                        <span class="row-name">{{ item.name }}</span>
                    </span>
                </td>
                <td>{{ "%.1f"|format(item.metrics.occ_percent) }}%</td>
                <td class="{{ 'positive' if item.metrics.occ_vs_ly > 0 else 'negative' }}">
                    {{ "+%.1f"|format(item.metrics.occ_vs_ly) if item.metrics.occ_vs_ly > 0 else "%.1f"|format(item.metrics.occ_vs_ly) }}%
                </td>
                <td>${{ "{:,.0f}".format(item.metrics.forecast_rev) }}</td>
            </tr>
            {% if item.children %}
                {% for child in item.children %}
                    {{ render_row(child, level + 1) }}
                {% endfor %}
            {% endif %}
            {% endmacro %}
            
            {{ render_row(data, 0) }}
        </tbody>
    </table>
</div>

<script>
    function toggleChildren(element) {
        const tr = element.closest('tr');
        const currentLevel = parseInt(tr.dataset.level);
        let nextTr = tr.nextElementSibling;

        const isCollapsing = element.textContent === '[-]';
        element.textContent = isCollapsing ? '[+]' : '[-]';

        while (nextTr) {
            const nextLevel = parseInt(nextTr.dataset.level);
            if (nextLevel <= currentLevel) {
                break; // Stop when we reach a sibling or a parent
            }
            if (isCollapsing) {
                nextTr.classList.add('hidden');
            } else {
                // Only show direct children. Their own children's visibility
                // depends on their own toggle state.
                if (nextLevel === currentLevel + 1) {
                    nextTr.classList.remove('hidden');
                    const childToggle = nextTr.querySelector('.toggle');
                    if (childToggle && childToggle.textContent === '[+]') {
                        // If this child row was collapsed, keep its children hidden.
                        // We do this by immediately breaking the loop after showing the child.
                        let tempNext = nextTr.nextElementSibling;
                        while(tempNext && parseInt(tempNext.dataset.level) > nextLevel) {
                            tempNext = tempNext.nextElementSibling;
                        }
                        nextTr = tempNext;
                        continue;
                    }
                }
            }
            nextTr = nextTr.nextElementSibling;
        }
    }
</script>
{% endblock %}